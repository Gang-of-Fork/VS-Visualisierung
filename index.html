<!doctype html>
<html lang="de">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>Visualisierung Verteilte Systeme</title>
</head>

<body>
    <div>
        <h3>X-Size: <span id="xsize"></span> Y-Size: <span id="ysize"></span> Number of Nodes: <span
                id="numOfNodes"></span></h3>
    </div>
    <div class="row">
        <div id="visualization" class="col"></div>
        <div class="col">
            <div class="card" style="margin-bottom: 30px;">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="formFile" class="form-label">Daten ausw√§hlen</label>
                        <input class="form-control" type="file" id="upload">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div id="nodeInfo" class="card" style="width: 18rem;">
                        <div id="initNodeInfo" class="card-body">
                        <h5 class="card-title">Node Info</h5>
                        <p class="card-text">Selektiere eine Node um weitere Informationen zu erhalten</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div id="dataLog" class="card" style="width: 18rem;">
                        <div id="initDataLog" class="card-body">
                        <h5 class="card-title">Daten Log</h5>
                        <p class="card-text">Lade eine Datei hoch, um hier den Log zu verfolgen</p>
                        </div>
                    </div>
                    <!--Slider for Log Navigation-->
                    <div style="text-align: center; margin-top: 20px;">
                        <div id="dataRagenSlider"></div>
                    </div>

                </div>
              </div>
        </div>
    </div>


    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- Include D3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>

    <style>
        body {
            margin: 40px
        }
    </style>

    <!-- Configuration constants -->
    <script>
        const dot_radius = 10;
        const label_size = dot_radius * 0.9;
    </script>

    <!-- Custom D3.js code -->
    <script>
        function initViz(data) {
            // set the dimensions and margins of the graph
            const margin = { top: 10, right: 40, bottom: 30, left: 30 };
            const width = 800 - margin.left - margin.right;
            const height = 800 - margin.top - margin.bottom;

            //reset function for later selection
            const resetSelection = function () {
                d3.selectAll("circle").attr("stroke", "black");
                return nodeInfo 
                    .style("visibility", "visible")
                    .style("position", "relative")
                    .html(`<h5 class="card-title">Node Info</h5>
                  <p class="card-text">Selektiere eine Node um weitere Informationen zu erhalten</p>`);
            }

            //append the svg object to the visualization div
            const svg = d3.select("#visualization")
                .append("svg")
                .on("click", resetSelection)
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                // translate this svg element to leave some margin.
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

            // X scale and Axis
            const x = d3.scaleLinear()
                .domain([0, 100])         // This is the min and the max of the data: 0 to 100 if percentages
                .range([0, width]);       // This is the corresponding value I want in Pixel

            svg
                .append('g')
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            // X scale and Axis
            const y = d3.scaleLinear()
                .domain([0, 100])         // This is the min and the max of the data: 0 to 100 if percentages
                .range([height, 0]);       // This is the corresponding value I want in Pixel

            svg
                .append('g')
                .call(d3.axisLeft(y))

            const tooltip = d3.select("#visualization")
                .append("div")
                .classed("card", true)
                .attr("id", "circleBasicTooltip")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("z-index", "900")
                .text("I'm a circle!");

            const nodeInfo = d3.select("#nodeInfo")
                .append("div")
                .classed("card-body", true)
                .style("position", "absolute")
                .style("visibility", "hidden")
                .text("I'm a Node Info");

            //define Node-Events
            const mouseover = function (d) {
                d3.select(this).style("cursor", "pointer");
                return tooltip
                    .style("visibility", "visible")
                    .html("Node ID: " + d.id + "<br/> X: " + d.x + " Y: " + d.y);
            }

            const mousemove = function () {
                return tooltip.style("top", (event.pageY - 20) + "px")
                    .style("left", (event.pageX + 20) + "px")
            }

            const mouseleave = function () { 
                d3.select(this).style("cursor", "default"); 
                return tooltip.style("visibility", "hidden"); 
            }

            const click = function (d) {
                event.stopPropagation();
                //remove card info
                d3.select("#initNodeInfo").remove();
                //reset color of all nodes in range
                d3.selectAll("circle").attr("stroke", "black");
                //change color of nodes in range
                d3.select(`#nodeCircle${d.id}`).attr("stroke", "orange");
                for(let x of d.inRange){
                    d3.select(`#nodeCircle${x}`).attr("stroke", "blue");
                }
                //add node info in card on right side
                let html = `<h5 class="card-title">Node Info</h5>
                        <h6 class="card-subtitle mb-2 text-muted">Node ID: ${d.id}</h6>
                        <p class="card-text">X: ${d.x}, Y: ${d.y} </br>`
                if(d.routingTable.length > 0){
                    html += `Routing Tabelle: ${d.routingTable} </br>` 
                }
                if(d.inRange.length > 0){
                    html += `In Reichweite: ${d.inRange}</p>`
                }
                return nodeInfo 
                    .style("visibility", "visible")
                    .style("position", "relative")
                    .html(html);
            }

            const elemEnter = svg
                .selectAll("enterEle")
                .data(data)
                .enter()

            const circles = elemEnter
                .append("circle")
                .attr("id", function(d) { return "nodeCircle" + d.id})
                .attr("cx", function (d) { return x(d.x) })
                .attr("cy", function (d) { return y(d.y) })
                .attr("r", dot_radius)
                .attr("stroke", "black")
                .attr("fill", "transparent")
                .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave)
                .on("click", click);

                const texts = elemEnter
                .append("text")
                .attr("id", function(d) { return "nodeText" + d.id })
                .attr("x", function (d) { return x(d.x) })
                .attr("y", function (d) { return y(d.y) + 0.4 * label_size })
                .attr('font-size', label_size)
                .attr("text-anchor", "middle")
                .text(function (d) { return "" + d.id });
        }

        function resetViz() {
            console.log(document.getElementsByTagName("div"));
            document.getElementById("visualization").innerHTML = "";
        }


        function rreqViz(data){
            //color sending, receiving_discarding and receiving_processing
            d3.select(`#nodeCircle${data.actions.sending}`).attr("fill", "#5d8e91");
            for(let i = 0; i < data.actions.receiving_discarding.length; i++){
                d3.select(`#nodeCircle${data.actions.receiving_discarding[i]}`).attr("fill", "#757575");
            }
            d3.select(`#nodeCircle${data.actions.receiving_processing}`).attr("fill", "#82e2ff");

            
        };


        function changeState(d){
            d3.select(`#logElement${currentState}`).style("color", "black").style("font-weight", "normal");
            currentState = d;
            d3.select(`#logElement${currentState}`).style("color", "green").style("font-weight", "700");
            //here switch case if testdata[currentState].type === RREQ than function ...
        }


        var data = []

        initViz(data);

        //DOM Event Handlers
        const inputElement = document.getElementById("upload");
        inputElement.addEventListener("change", handleFiles, false);
        function handleFiles() {
            const fileList = this.files;
            console.log(this.files);

            const reader = new FileReader();

            reader.addEventListener('load', (event) => {
                const parsed = JSON.parse(event.target.result);
                console.log(parsed);

                const init = parsed.filter(d => d.type == "INIT")[0];
                const rreq = parsed.filter(d => d.type == "RREQ")[0];

                console.log(rreq);
                console.log(init);

                //set config
                document.getElementById("numOfNodes").innerHTML = init.nodes.length;
                document.getElementById("xsize").innerHTML = init.xsize;
                document.getElementById("ysize").innerHTML = init.ysize;

                resetViz();
                initViz(init.nodes);
                rreqViz(rreq);
                let html = `<h5 class="card-title">Daten Log</h5>`;
                for(x in parsed){
                    html += `<span id="logElement${x}">${x}: ${parsed[x].type}<br/></span>`;
                }
                d3.select("#dataLog").append("div").classed("card-body", true).html(html);
                //coloring current state green
                d3.select(`#logElement${currentState}`).style("color", "green").style("font-weight", "700");

                document.getElementById("dataRagenSlider").innerHTML = `<input type="range" class="form-range" min="0" max="${parsed.length-1}" value=${currentState} step="1" oninput="changeState(this.value)" id="customRange3">`;

            });

            reader.readAsText(this.files[0])
        }
    </script>
</body>

</html>